<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cash Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
.access-denied {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: Arial, sans-serif;
  text-align: center;
}
.access-denied h1 { color: red; }
.access-denied a {
  margin-top: 10px;
  text-decoration: none;
  color: blue;
}

  body { font-family: Arial, sans-serif; margin: 20px; }
  .access-denied {
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    height:100vh; text-align:center; font-family:Arial, sans-serif;
  }
  .access-denied h1 { color:red; }
  .access-denied a { margin-top:20px; text-decoration:none; color:blue; font-size:18px; }
  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 5px; }
  button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; }
  .back-btn { background: #ef4444; color: #fff; }
  .add-btn { background: #22c55e; color: #fff; margin-left: 10px; }
  .nav-btn { background: #334155; color: #fff; margin-left: 5px; }
  .delete-btn { background: #ef4444; color: #fff; padding: 4px 8px; border-radius: 4px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  th { background: #f3f3f3; cursor: col-resize; }
  .right { text-align: right; }
  input.manual-input { width: 100%; box-sizing: border-box; padding: 2px 4px; font-size: 14px; }
</style>


</head>
<body>

<div class="top-bar">
  <h1>Cash Control</h1>
  <div>
    <button class="back-btn" onclick="location.href='index.html'">Back to Home</button>
    <button class="nav-btn" onclick="location.href='customers.html'">Customers</button>
    <button class="nav-btn" onclick="location.href='invoice.html'">New Invoice</button>
    <button class="nav-btn" onclick="location.href='invoicelist.html'">Invoices List</button>
    <button class="nav-btn" onclick="location.href='products.html'">Products</button>
    <button class="add-btn" onclick="addManualEntry()">Add Manual Entry</button>
  </div>
</div>

<table>
  <thead>
    <tr id="header-row">
      <th data-col="date">Date</th>
      <th data-col="description">Description</th>
      <th data-col="debit">Debit</th>
      <th data-col="credit">Credit</th>
      <th data-col="balance">Balance</th>
      <th data-col="actions">Actions</th>
    </tr>
  </thead>
  <tbody id="cash-body"></tbody>
</table>

<script>
// ===== BLOCK DIRECT ACCESS =====
if (sessionStorage.getItem("fromIndex") !== "true") {
    document.body.innerHTML = `
    <div class="access-denied">
        <h1>Access Denied</h1>
        <p>Please open this app using <strong>index.html</strong>.</p>
        <a href="index.html">Go to Home</a>
    </div>
    `;
    throw "Access Denied"; // stop further execution
}

// Clear the flag so refreshing doesn't bypass
sessionStorage.removeItem("fromIndex");

  const cashBody = document.getElementById('cash-body');
  const headerRow = document.getElementById('header-row');

  // Drag to resize columns
  let startX, startWidth, resizableTh;
  headerRow.querySelectorAll('th').forEach(th => {
    th.addEventListener('mousedown', function(e) {
      resizableTh = th;
      startX = e.pageX;
      startWidth = th.offsetWidth;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });

  function onMouseMove(e) {
    if (!resizableTh) return;
    const diff = e.pageX - startX;
    resizableTh.style.width = (startWidth + diff) + 'px';
  }
  function onMouseUp() {
    resizableTh = null;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  // Render cash control table
  function renderCashControl() {
    let cashControl = JSON.parse(localStorage.getItem('cashControl')) || [];
    cashControl.sort((a, b) => new Date(a.date) - new Date(b.date));

    cashBody.innerHTML = '';
    let runningBalance = 0;

    cashControl.forEach((entry, index) => {
      const debit = parseFloat(entry.debit) || 0;
      const credit = parseFloat(entry.credit) || 0;
      runningBalance += debit - credit;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="manual-input" type="date" value="${entry.date}" 
                   onchange="updateCashLine(${index}, 'date', this.value)" /></td>
        <td><input class="manual-input" type="text" value="${entry.description}" 
                   onchange="updateCashLine(${index}, 'description', this.value)" /></td>
        <td><input class="manual-input right" type="number" min="0" step="0.01" value="${debit}" 
                   onchange="updateCashLine(${index}, 'debit', this.value)" /></td>
        <td><input class="manual-input right" type="number" min="0" step="0.01" value="${credit}" 
                   onchange="updateCashLine(${index}, 'credit', this.value)" /></td>
        <td class="right">${runningBalance.toFixed(2)}</td>
        <td><button class="delete-btn" onclick="deleteCashLine(${index})">Delete</button></td>
      `;
      cashBody.appendChild(tr);
    });

    localStorage.setItem('cashControl', JSON.stringify(cashControl));
  }

  function updateCashLine(index, field, value) {
    let cashControl = JSON.parse(localStorage.getItem('cashControl')) || [];
    if (!cashControl[index]) return;
    if (field === 'debit' || field === 'credit') {
      cashControl[index][field] = parseFloat(value) || 0;
    } else {
      cashControl[index][field] = value;
    }
    localStorage.setItem('cashControl', JSON.stringify(cashControl));
    renderCashControl();
  }

  function deleteCashLine(index) {
    if (!confirm('Are you sure you want to delete this entry?')) return;
    let cashControl = JSON.parse(localStorage.getItem('cashControl')) || [];
    cashControl.splice(index, 1);
    localStorage.setItem('cashControl', JSON.stringify(cashControl));
    renderCashControl();
  }

  function addManualEntry() {
    let cashControl = JSON.parse(localStorage.getItem('cashControl')) || [];
    const today = new Date().toISOString().split('T')[0];
    cashControl.push({ date: today, description: 'Manual Entry', debit: 0, credit: 0 });
    localStorage.setItem('cashControl', JSON.stringify(cashControl));
    renderCashControl();
    setTimeout(() => {
      const rows = cashBody.querySelectorAll('tr');
      if (rows.length) rows[rows.length - 1].scrollIntoView({ behavior: 'smooth' });
    }, 50);
  }

  window.addEventListener('storage', (e) => {
    if (e.key === 'cashControl') renderCashControl();
  });

  renderCashControl();
</script>

</body>
</html>
